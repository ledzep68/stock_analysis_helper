# エラーログ - ポートフォリオ管理システム

## 2025-06-29: 重大なサーバー接続障害とポートフォリオエラー対応

### 🚨 発生した問題

#### 1. 空ポートフォリオでの500エラー
- **症状**: ポートフォリオに保有銘柄が一件もない場合に500エラー発生
- **原因**: 0除算エラー（空配列での計算処理）
- **影響範囲**: ポートフォリオサマリー、パフォーマンス分析、リスク分析

#### 2. バックエンドサーバー接続不可
- **症状**: サーバー起動メッセージは出るが、実際にポートにバインドされない
- **原因**: ポート5003の環境的問題（プロキシ設定競合の可能性）
- **影響範囲**: 全API機能停止、フロントエンド完全機能不全

#### 3. CSP（Content Security Policy）違反
- **症状**: `xhr.js:195 Refused to connect to 'http://localhost:5555/api/portfolio'`
- **原因**: CSPのconnect-srcディレクティブにポート5555が未登録
- **影響範囲**: フロントエンドからのAPI呼び出し全般

### ✅ 実施した対応

#### 1. 空ポートフォリオエラー対応
**ファイル**: `backend/src/services/portfolioService.ts`
```typescript
// 保有銘柄が空の場合の処理を追加
if (holdings.length === 0) {
  return {
    portfolio,
    totalValue: 0,
    totalCost: 0,
    unrealizedPnL: 0,
    realizedPnL: 0,
    totalReturn: 0,
    totalReturnPercent: 0,
    holdingsCount: 0,
    topHoldings: []
  };
}
```

**ファイル**: `backend/src/services/portfolioPerformanceService.ts`
```typescript
if (holdings.length === 0) {
  return []; // 空配列を返す
}
```

**ファイル**: `backend/src/services/portfolioRiskService.ts`
```typescript
if (holdings.length === 0) {
  const defaultRisk: PortfolioRisk = {
    overall: { /* デフォルト値 */ },
    breakdown: { /* ゼロ値 */ },
    recommendations: ['保有銘柄を追加してリスク分析を開始してください']
  };
  return defaultRisk;
}
```

#### 2. ポート変更対応
- **バックエンド**: ポート5003 → 5555
  - `backend/.env`: `PORT=5555`
  - `backend/src/index.ts`: デフォルトポート変更
- **フロントエンド**: API接続先変更
  - `frontend/src/services/api.ts`: `http://localhost:5555/api`
  - `frontend/package.json`: プロキシ設定削除
  - `frontend/setupProxy.js`: ポート5555に変更

#### 3. CSP設定修正
**ファイル**: `frontend/public/index.html`
```html
connect-src 'self' ... http://localhost:5555 ws://localhost:5555 wss://localhost:5555 ...
```

#### 4. サーバー安定性改善
- WebSocketServiceとDataPersistenceServiceの初期化を非同期化
- エラーハンドリング強化
- デバッグ用のミニマルサーバー作成とテスト

### 📊 結果
- ✅ 空ポートフォリオでのエラー解消
- ✅ サーバー接続安定化
- ✅ API呼び出し正常化
- ✅ ポートフォリオ機能完全復旧

---

## 🔍 反省点と再発防止策

### 1. **ポート管理の標準化不足**
**問題**: 複数の設定ファイルでポート番号がハードコードされていた
**対策**: 
- 環境変数の一元管理
- 設定ファイルの依存関係マップ作成
- ポート変更時のチェックリスト作成

### 2. **エラーハンドリングの空データ対応不足**
**問題**: 空配列や空オブジェクトでの計算処理が考慮されていない
**対策**:
- 全データ処理関数で空データケースのテスト必須化
- デフォルト値の明示的定義
- 境界値テストの強化

### 3. **サーバー起動確認の不十分さ**
**問題**: ログメッセージだけで実際のポートバインドを確認していない
**対策**:
- 起動後の接続テスト自動化
- ヘルスチェックエンドポイントの必須実装
- 起動スクリプトでの接続確認

### 4. **設定ファイル間の整合性チェック不足**
**問題**: フロントエンドとバックエンドの設定不整合を事前検出できない
**対策**:
- 設定値の自動検証スクリプト作成
- CI/CDでの設定整合性チェック
- 開発環境セットアップの自動化

### 5. **CSP設定の動的更新対応不足**
**問題**: ポート変更時にCSPの更新を忘れやすい
**対策**:
- CSP設定の環境変数化
- 開発環境でのCSP緩和設定
- 本番環境との設定分離

### 6. **デバッグ手順の体系化不足**
**問題**: サーバー問題の切り分けが非効率だった
**対策**:
- トラブルシューティングガイド作成
- 段階的デバッグ手順の標準化
- ミニマル環境での検証手順確立

### 7. **プロキシ設定の複雑性**
**問題**: package.jsonとsetupProxy.jsの競合が理解不足だった
**対策**:
- プロキシ設定方法の統一
- 開発環境での直接接続推奨
- プロキシ使用時の明確な理由文書化

### 8. **エラーログの不足**
**問題**: 問題発生時の詳細ログが不十分だった
**対策**:
- 構造化ログの導入
- エラーレベルの明確化
- ログローテーション設定

### 9. **テスト環境の不備**
**問題**: 空データケースのテストが不十分だった
**対策**:
- エッジケーステストの強化
- テストデータの多様化
- 自動テストでの境界値確認

### 10. **依存関係の理解不足**
**問題**: React Scripts、WebPack、プロキシの相互作用が不明確だった
**対策**:
- 技術スタックの依存関係図作成
- 各技術の制約事項文書化
- アップデート時の影響範囲評価

### 11. **環境固有問題への対応不足**
**問題**: WSL環境やポート競合への対応が後手に回った
**対策**:
- 環境別の既知問題リスト作成
- 代替ポートの事前準備
- 環境診断スクリプトの作成

### 12. **変更影響範囲の予測不足**
**問題**: ポート変更の影響範囲を事前に把握できていない
**対策**:
- 変更インパクト分析の標準化
- 設定変更チェックリスト作成
- ロールバック手順の事前準備

### 13. **並行作業時の状態管理不足**
**問題**: バックエンド修正中にフロントエンドの設定が古いまま残った
**対策**:
- 変更作業の順序明確化
- 全コンポーネント同期確認
- 変更後の統合テスト必須化

### 14. **ドキュメント更新の遅れ**
**問題**: 設定変更時にドキュメントの更新が漏れやすい
**対策**:
- 設定変更時のドキュメント更新自動化
- README.mdのポート情報明記
- 設定変更履歴の記録

### 15. **エラー再現手順の不明確さ**
**問題**: 「ポートフォリオが見れない」という報告から具体的問題の特定に時間がかかった
**対策**:
- エラー報告テンプレート作成
- 再現手順の標準化
- ログ出力の改善とエラー詳細化

---

## 📋 今後の予防策チェックリスト

### 開発時
- [ ] 新機能実装時は空データケースのテスト実施
- [ ] ポート変更時は全設定ファイルを確認
- [ ] サーバー起動後は実際の接続テスト実行
- [ ] CSP設定変更時はブラウザでの動作確認

### デプロイ時
- [ ] 設定ファイル間の整合性確認
- [ ] ヘルスチェックの動作確認
- [ ] エラーハンドリングの動作確認
- [ ] ログ出力レベルの確認

### 問題発生時
- [ ] エラーメッセージの詳細記録
- [ ] 最小構成での問題再現
- [ ] 段階的な原因切り分け実施
- [ ] 修正後の全機能動作確認

---

**作成日**: 2025-06-29  
**更新者**: Claude Code Assistant  
**重要度**: 🔴 Critical - サービス全体停止レベル  
**対応時間**: 約2時間  
**影響ユーザー**: 全ユーザー（開発環境）