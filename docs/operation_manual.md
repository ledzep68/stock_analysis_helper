# 株式分析システム 運用手順書

## 目次
1. [システム概要](#システム概要)
2. [日常運用](#日常運用)
3. [東証企業データ更新手順](#東証企業データ更新手順)
4. [トラブルシューティング](#トラブルシューティング)
5. [緊急時対応](#緊急時対応)
6. [メンテナンススケジュール](#メンテナンススケジュール)

---

## システム概要

### システム構成
- **フロントエンド**: React (TypeScript) - ポート3000
- **バックエンド**: Node.js/Express (TypeScript) - ポート5003
- **データベース**: SQLite (ローカルファイル)
- **外部API**: Yahoo Finance, Alpha Vantage等（フォールバック用）

### 主要機能
1. 東証上場企業検索（約3,800社対応）
2. リアルタイム株価取得
3. 財務分析・投資判断支援
4. お気に入り管理
5. レポート生成

---

## 日常運用

### システム起動手順

#### 1. バックエンド起動
```bash
cd backend
npm run dev
```
- 正常起動の確認: `Server is running on port 5003`
- データベース接続確認: `Connected to SQLite database`

#### 2. フロントエンド起動
```bash
cd frontend
npm start
```
- ブラウザが自動的に開きます
- URL: http://localhost:3000

### システム停止手順
1. フロントエンド: `Ctrl + C`
2. バックエンド: `Ctrl + C`

### 日次確認事項
- [ ] システムアクセス可能か
- [ ] 検索機能が正常動作するか
- [ ] 外部API制限に達していないか

---

## 東証企業データ更新手順

### 更新タイミング
- **定期更新**: 毎月第1営業日
- **臨時更新**: 大型IPO、企業合併時

### 更新アラート
システムが以下のタイミングで管理者に通知します：
- 毎月1日: 定期更新リマインダー
- データが30日以上古い場合: 警告表示

### 更新手順（所要時間: 約10分）

#### 1. JPXデータのダウンロード
1. [JPX統計資料ページ](https://www.jpx.co.jp/markets/statistics-equities/misc/01.html)にアクセス
2. 「その他統計資料」セクションを探す
3. 「東証上場銘柄一覧」をクリック
4. Excelファイル（data_j.xls）をダウンロード

#### 2. データの配置
```bash
# ダウンロードしたファイルを指定フォルダに移動
mv ~/Downloads/data_j.xls ~/stock_analysis_helper/backend/data/
```

#### 3. データ変換（必要な場合）
ExcelファイルをCSVに変換：
- Excelで開く → 名前を付けて保存 → CSV形式
- または、オンライン変換ツールを使用

#### 4. インポート実行
```bash
cd ~/stock_analysis_helper/backend

# 現在のデータをバックアップ（推奨）
npm run jpx:backup

# 新データをインポート
npm run jpx:import
```

#### 5. 確認
```bash
# インポート結果の確認
npm run jpx:verify

# 期待される出力:
# ✅ 総企業数: 3,800社以上
# ✅ データ整合性OK
```

### 更新コマンド一覧

| コマンド | 説明 | 使用タイミング |
|---------|------|---------------|
| `npm run jpx:backup` | 現在のデータをバックアップ | 更新前 |
| `npm run jpx:import` | JPXデータをインポート | 更新時 |
| `npm run jpx:verify` | データ整合性チェック | 更新後 |
| `npm run jpx:rollback` | 前回のバックアップに戻す | エラー時 |
| `npm run jpx:status` | 最終更新日時を確認 | 随時 |

---

## トラブルシューティング

### よくある問題と対処法

#### 1. インポートエラー
```
Error: SQLITE_ERROR: no such table: companies
```
**対処法**: 
```bash
npm run db:setup  # データベース初期化
npm run jpx:import  # 再度インポート
```

#### 2. 文字化け
**対処法**: 
- CSVファイルの文字コードをUTF-8に変換
- Excelで開いて再保存

#### 3. データ不整合
```
⚠️ 重複データが見つかりました
```
**対処法**:
```bash
npm run jpx:clean  # 重複データクリーンアップ
npm run jpx:import --force  # 強制インポート
```

#### 4. パフォーマンス低下
**対処法**:
```bash
npm run db:optimize  # インデックス再構築
```

### ログ確認
```bash
# 更新ログ
tail -f backend/logs/jpx-update.log

# エラーログ
tail -f backend/logs/error.log

# アクセスログ
tail -f backend/logs/access.log
```

---

## 緊急時対応

### データ破損時
1. サービス停止
   ```bash
   npm run stop:all
   ```

2. バックアップから復元
   ```bash
   npm run jpx:rollback
   npm run db:verify
   ```

3. サービス再開
   ```bash
   npm run start:all
   ```

### 外部API障害時
- システムは自動的にローカルDBにフォールバック
- 管理画面で `API Status: Fallback Mode` を確認

### セキュリティインシデント
1. 即座にサービス停止
2. ログを保全
3. 原因調査
4. 対策実施後に再開

---

## メンテナンススケジュール

### 定期メンテナンス

#### 月次作業（第1営業日）
- [ ] JPXデータ更新
- [ ] バックアップ確認
- [ ] ログローテーション
- [ ] パフォーマンス確認

#### 四半期作業
- [ ] 依存パッケージ更新
- [ ] セキュリティパッチ適用
- [ ] データベース最適化
- [ ] 古いバックアップ削除

#### 年次作業
- [ ] メジャーバージョンアップグレード検討
- [ ] インフラ見直し
- [ ] 災害復旧訓練

### 監視項目

#### システムメトリクス
- CPU使用率: < 80%
- メモリ使用率: < 70%
- ディスク使用率: < 80%
- レスポンスタイム: < 2秒

#### ビジネスメトリクス
- 日次アクティブユーザー数
- 検索成功率: > 95%
- API呼び出し数（コスト管理）

### 連絡先

#### システム管理者
- 主担当: [担当者名]
- 副担当: [担当者名]
- 緊急連絡先: [電話番号]

#### エスカレーション
1. Level 1: システム管理者
2. Level 2: 開発チーム
3. Level 3: 経営層

---

## 付録

### チェックリスト

#### 月次更新チェックリスト
- [ ] JPXサイトで最新データ確認
- [ ] データダウンロード
- [ ] バックアップ実行
- [ ] インポート実行
- [ ] 動作確認
- [ ] ログ確認
- [ ] 完了報告

#### 障害対応チェックリスト
- [ ] 影響範囲確認
- [ ] 初期対応実施
- [ ] 原因調査
- [ ] 恒久対策実施
- [ ] 再発防止策策定
- [ ] 報告書作成

### 便利なコマンド集

```bash
# システム状態確認
npm run health:check

# データベース統計
npm run db:stats

# キャッシュクリア
npm run cache:clear

# 全ログ確認
npm run logs:tail

# バックアップリスト表示
npm run backup:list

# システム情報表示
npm run system:info
```

### 改訂履歴
- 2025-06-22: 初版作成
- [更新日]: [更新内容]

---

**重要**: この手順書は定期的に見直し、最新の状態を保つこと。