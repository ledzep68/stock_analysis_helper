# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆæ€æƒ³

## 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆåŸå‰‡

### 1.1 è¨­è¨ˆæ€æƒ³
StockAnalysis Helperã¯**é‡‘èæƒ…å ±ã‚’æ‰±ã†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**ã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸå‰‡ã«åŸºã¥ã„ã¦è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ï¼š

#### æ ¸å¿ƒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸå‰‡
1. **å¤šå±¤é˜²å¾¡**: è¤‡æ•°ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚ˆã‚‹ä¿è­·
2. **æœ€å°æ¨©é™**: å¿…è¦æœ€å°é™ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®ã¿ä»˜ä¸
3. **é€æ˜æ€§**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®æ˜ç¢ºåŒ–
4. **æ³•çš„ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹**: é‡‘èæƒ…å ±å–ã‚Šæ‰±ã„ã®é©æ³•æ€§ç¢ºä¿

### 1.2 å®Ÿè£…å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
- âœ… **XSSå¯¾ç­–**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŒæ–¹ã§å®Œå…¨å®Ÿè£…
- âœ… **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: ä¸€èˆ¬ã‚¢ã‚¯ã‚»ã‚¹ãƒ»APIãƒ»å¤–éƒ¨APIã®3å±¤åˆ¶é™
- âœ… **CSP**: å³æ ¼ãªContent Security Policyå®Ÿè£…
- âœ… **å…¥åŠ›æ¤œè¨¼**: å¤šå±¤çš„ãªæ¤œè¨¼ãƒ»ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
- âœ… **CORSåˆ¶é™**: æœ¬ç•ªç’°å¢ƒå¯¾å¿œã®å³æ ¼ãªè¨­å®š
- âœ… **DoSé˜²æ­¢**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚µã‚¤ã‚ºãƒ»é »åº¦åˆ¶é™
- âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼**: åŒ…æ‹¬çš„ãªHTTPã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
- âœ… **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: æƒ…å ±æ¼æ´©é˜²æ­¢ã®å®‰å…¨ãªã‚¨ãƒ©ãƒ¼å‡¦ç†

### 1.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„…å¨ã®åˆ†æ

#### æƒ³å®šã•ã‚Œã‚‹è„…å¨
1. **XSSæ”»æ’ƒ**: æ‚ªæ„ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã‚‹æŠ•è³‡åˆ¤æ–­æƒ…å ±ã®æ”¹ã–ã‚“
2. **CSRFæ”»æ’ƒ**: ä¸æ­£ãªæŠ•è³‡é–¢é€£æ“ä½œã®å®Ÿè¡Œ
3. **SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å°å…¥æ™‚ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹
4. **APIã‚­ãƒ¼æ¼æ´©**: å¤–éƒ¨APIä½¿ç”¨æ–™é‡‘ã®ä¸æ­£åˆ©ç”¨
5. **DDoSæ”»æ’ƒ**: ã‚µãƒ¼ãƒ“ã‚¹å¯ç”¨æ€§ã¸ã®æ”»æ’ƒ
6. **ãƒ‡ãƒ¼ã‚¿æ”¹ã–ã‚“**: å½ã®æ ªä¾¡æƒ…å ±ã«ã‚ˆã‚‹æŠ•è³‡åˆ¤æ–­ãƒŸã‚¹ãƒªãƒ¼ãƒ‰
7. **å€‹äººæƒ…å ±æ¼æ´©**: å°†æ¥å®Ÿè£…ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ä¿è­·
8. **æ³•çš„ãƒªã‚¹ã‚¯**: æŠ•è³‡åŠ©è¨€æ¥­é•åã®æŒ‡æ‘˜

## 2. API ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 2.1 APIã‚­ãƒ¼ç®¡ç†

#### ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹æ©Ÿå¯†æƒ…å ±ä¿è­·
```typescript
// backend/.env
PORT=5000
NODE_ENV=development
YAHOO_FINANCE_API_KEY=your_api_key_here
ALPHA_VANTAGE_API_KEY=your_api_key_here
```

#### è¨­è¨ˆåˆ¤æ–­ã®ç†ç”±
- **ç’°å¢ƒåˆ†é›¢**: é–‹ç™ºãƒ»æœ¬ç•ªç’°å¢ƒã§ã®ã‚­ãƒ¼åˆ†é›¢
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†é™¤å¤–**: .gitignoreã«ã‚ˆã‚‹èª¤ã‚³ãƒŸãƒƒãƒˆé˜²æ­¢
- **ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å‚ç…§**: ãƒ—ãƒ­ã‚»ã‚¹ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã®å‹•çš„å–å¾—

#### APIã‚­ãƒ¼æ¤œè¨¼
```typescript
const validateApiConfig = (): boolean => {
  const requiredKeys = ['YAHOO_FINANCE_API_KEY', 'ALPHA_VANTAGE_API_KEY'];
  
  for (const key of requiredKeys) {
    if (!process.env[key] || process.env[key] === 'your_api_key_here') {
      console.error(`Missing or invalid API key: ${key}`);
      return false;
    }
  }
  return true;
};

// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚ã®æ¤œè¨¼
if (!validateApiConfig()) {
  process.exit(1);
}
```

### 2.2 ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¨­è¨ˆ

#### Phase 2ã§ã®å®Ÿè£…äºˆå®š
```typescript
import rateLimit from 'express-rate-limit';

const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†é–“
  max: 100, // ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸Šé™
  message: {
    success: false,
    error: 'Rate limit exceeded. Please try again later.',
    timestamp: new Date().toISOString()
  },
  standardHeaders: true,
  legacyHeaders: false,
});

app.use('/api/', apiLimiter);
```

#### å¤–éƒ¨APIåˆ©ç”¨åˆ¶é™ã®è€ƒæ…®
```typescript
class ApiRateLimiter {
  private lastCall: Map<string, number> = new Map();
  private readonly minInterval = 1000; // 1ç§’é–“éš”

  async throttle(apiName: string): Promise<void> {
    const now = Date.now();
    const lastCallTime = this.lastCall.get(apiName) || 0;
    const timeSinceLastCall = now - lastCallTime;

    if (timeSinceLastCall < this.minInterval) {
      const waitTime = this.minInterval - timeSinceLastCall;
      await new Promise(resolve => setTimeout(resolve, waitTime));
    }

    this.lastCall.set(apiName, Date.now());
  }
}
```

## 3. XSSãƒ»ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒå¯¾ç­–

### 3.1 XSS (Cross-Site Scripting) å¯¾ç­–

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ XSS é˜²å¾¡
```typescript
// âœ… å®Ÿè£…æ¸ˆã¿: React ã®è‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ©Ÿèƒ½ã‚’æ´»ç”¨
const CompanyDisplay: React.FC<{ company: Company }> = ({ company }) => {
  return (
    <div>
      {/* React ã¯è‡ªå‹•çš„ã« HTML ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’è¡Œã† */}
      <h2>{company.name}</h2>
      <p>{company.symbol}</p>
      
      {/* dangerouslySetInnerHTML ã¯ä½¿ç”¨ç¦æ­¢ */}
      {/* <div dangerouslySetInnerHTML={{ __html: userInput }} /> */}
    </div>
  );
};

// âœ… å®Ÿè£…æ¸ˆã¿: å…¥åŠ›å€¤æ¤œè¨¼ã®å®Ÿè£…
import { validateSearchInput, getSafeErrorMessage } from '../utils/security';

const handleSearch = async () => {
  // å…¥åŠ›å€¤ã®å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
  if (!validateSearchInput(query)) {
    setError('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ç„¡åŠ¹ãªæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚');
    return;
  }
  // ...
};
```

#### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ XSS é˜²å¾¡
```typescript
// âœ… å®Ÿè£…æ¸ˆã¿: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®å®Ÿè£…
// backend/src/utils/security.ts

export const escapeHtml = (text: string): string => {
  const htmlEscapes: { [key: string]: string } = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#x27;',
    '/': '&#x2F;'
  };
  
  return text.replace(/[&<>"'/]/g, (match) => htmlEscapes[match]);
};

export const sanitizeObject = (obj: any): any => {
  if (typeof obj === 'string') {
    return escapeHtml(obj);
  }
  
  if (Array.isArray(obj)) {
    return obj.map(sanitizeObject);
  }
  
  if (obj && typeof obj === 'object') {
    const sanitized: any = {};
    for (const key in obj) {
      if (obj.hasOwnProperty(key)) {
        sanitized[key] = sanitizeObject(obj[key]);
      }
    }
    return sanitized;
  }
  
  return obj;
};

// âœ… å®Ÿè£…æ¸ˆã¿: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã®è‡ªå‹•ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
export const createSecureApiResponse = <T>(
  success: boolean,
  data?: T,
  error?: string
) => {
  const response = {
    success,
    timestamp: new Date().toISOString()
  } as any;
  
  if (success && data !== undefined) {
    response.data = sanitizeObject(data);  // è‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
  }
  
  if (!success && error) {
    response.error = escapeHtml(error);     // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
  }
  
  return response;
};
```

### 3.2 CSP (Content Security Policy) å®Ÿè£…

#### å³æ ¼ãª CSP ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
```typescript
// âœ… å®Ÿè£…æ¸ˆã¿: backend/src/index.ts
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'"],  // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Œå…¨ã«ç¦æ­¢
      styleSrc: [
        "'self'",
        "'unsafe-inline'",  // Material-UI ã®å‹•çš„ã‚¹ã‚¿ã‚¤ãƒ«ã®ãŸã‚
        "fonts.googleapis.com"
      ],
      fontSrc: [
        "'self'",
        "fonts.gstatic.com"
      ],
      imgSrc: [
        "'self'",
        "data:",
        "https:"
      ],
      connectSrc: [
        "'self'",
        "https://query1.finance.yahoo.com",
        "https://www.alphavantage.co"
      ],
      objectSrc: ["'none'"],
      mediaSrc: ["'none'"],
      frameSrc: ["'none'"],
      frameAncestors: ["'none'"],
      formAction: ["'self'"],
      baseUri: ["'self'"]
    }
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}));
```

#### CSP é•åãƒ¬ãƒãƒ¼ãƒˆã®åé›†
```typescript
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      // ... ä¸Šè¨˜ã®è¨­å®š
      reportUri: '/api/csp-report'
    },
    reportOnly: false  // æœ¬ç•ªç’°å¢ƒã§ã¯ false ã«è¨­å®š
  }
}));

// CSP é•åãƒ¬ãƒãƒ¼ãƒˆã®å‡¦ç†
app.post('/api/csp-report', express.json({ type: 'application/csp-report' }), (req, res) => {
  console.warn('CSP Violation:', JSON.stringify(req.body, null, 2));
  res.status(204).end();
});
```

### 3.3 CSRF (Cross-Site Request Forgery) å¯¾ç­–

#### CSRF ãƒˆãƒ¼ã‚¯ãƒ³å®Ÿè£…ï¼ˆPhase 2äºˆå®šï¼‰
```typescript
import csrf from 'csurf';

const csrfProtection = csrf({
  cookie: {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict'
  }
});

// çŠ¶æ…‹å¤‰æ›´ã‚’ä¼´ã†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«é©ç”¨
app.use('/api/favorites', csrfProtection);
app.use('/api/alerts', csrfProtection);
app.use('/api/settings', csrfProtection);

// CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã®æä¾›
app.get('/api/csrf-token', csrfProtection, (req, res) => {
  res.json({ csrfToken: req.csrfToken() });
});
```

#### SameSite Cookie è¨­å®š
```typescript
app.use(session({
  cookie: {
    sameSite: 'strict',  // CSRF æ”»æ’ƒã‚’å¤§å¹…ã«è»½æ¸›
    secure: process.env.NODE_ENV === 'production',
    httpOnly: true
  }
}));
```

## 4. ãƒ‡ãƒ¼ã‚¿ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 4.1 å…¥åŠ›æ¤œè¨¼ãƒ»ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³

#### ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼
```typescript
const validateSearchQuery = (query: unknown): string | null => {
  if (typeof query !== 'string') {
    return null;
  }
  
  // é•·ã•åˆ¶é™
  if (query.length > 100) {
    return null;
  }
  
  // å±é™ºãªæ–‡å­—ã®ãƒã‚§ãƒƒã‚¯
  const dangerousChars = /[<>'"&]/;
  if (dangerousChars.test(query)) {
    return null;
  }
  
  // è‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ãƒ‰ãƒƒãƒˆã®ã¿è¨±å¯
  const allowedChars = /^[a-zA-Z0-9.\-\s]+$/;
  if (!allowedChars.test(query)) {
    return null;
  }
  
  return query.trim();
};
```

#### éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰æ¤œè¨¼
```typescript
const validateSymbol = (symbol: unknown): string | null => {
  if (typeof symbol !== 'string') {
    return null;
  }
  
  // ä¸€èˆ¬çš„ãªéŠ˜æŸ„ã‚³ãƒ¼ãƒ‰å½¢å¼ã®ãƒã‚§ãƒƒã‚¯
  const symbolPattern = /^[A-Z0-9]{1,10}(\.[A-Z]{1,3})?$/;
  const normalized = symbol.toUpperCase().trim();
  
  return symbolPattern.test(normalized) ? normalized : null;
};
```

### 3.2 å‡ºåŠ›ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—

#### JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
```typescript
const sanitizeForJson = (obj: any): any => {
  if (typeof obj === 'string') {
    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    return obj
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#x27;');
  }
  
  if (Array.isArray(obj)) {
    return obj.map(sanitizeForJson);
  }
  
  if (obj && typeof obj === 'object') {
    const sanitized: any = {};
    for (const key in obj) {
      sanitized[key] = sanitizeForJson(obj[key]);
    }
    return sanitized;
  }
  
  return obj;
};
```

## 4. é€šä¿¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 4.1 HTTPSå¼·åˆ¶

#### æœ¬ç•ªç’°å¢ƒã§ã®è¨­å®š
```typescript
// Helmet.jsã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'", "fonts.googleapis.com"],
      fontSrc: ["'self'", "fonts.gstatic.com"],
      imgSrc: ["'self'", "data:", "https:"],
      scriptSrc: ["'self'"],
      connectSrc: ["'self'", "https://query1.finance.yahoo.com"]
    }
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}));
```

### 4.2 CORSè¨­å®š

#### é©åˆ‡ãª CORS åˆ¶å¾¡
```typescript
import cors from 'cors';

const corsOptions = {
  origin: process.env.NODE_ENV === 'production' 
    ? ['https://your-domain.com'] 
    : ['http://localhost:3000'],
  optionsSuccessStatus: 200,
  credentials: false  // èªè¨¼ãªã—ã§ã®Cookieé€ä¿¡ã‚’ç¦æ­¢
};

app.use(cors(corsOptions));
```

#### é–‹ç™ºç’°å¢ƒã§ã®è¨­å®š
```typescript
// é–‹ç™ºç’°å¢ƒã§ã®CORSè¨­å®š
const devCorsOptions = {
  origin: ['http://localhost:3000', 'http://127.0.0.1:3000'],
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization']
};
```

## 5. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 5.1 æƒ…å ±æ¼æ´©ã®é˜²æ­¢

#### æœ¬ç•ªç’°å¢ƒã§ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
```typescript
const handleError = (error: Error, req: Request, res: Response) => {
  // è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
  console.error('Server Error:', {
    message: error.message,
    stack: error.stack,
    url: req.url,
    method: req.method,
    ip: req.ip,
    timestamp: new Date().toISOString()
  });

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ä¸€èˆ¬çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿è¿”å´
  if (process.env.NODE_ENV === 'production') {
    res.status(500).json({
      success: false,
      error: 'Internal server error',
      timestamp: new Date().toISOString()
    });
  } else {
    // é–‹ç™ºç’°å¢ƒã§ã¯è©³ç´°ã‚’è¿”å´
    res.status(500).json({
      success: false,
      error: error.message,
      stack: error.stack,
      timestamp: new Date().toISOString()
    });
  }
};
```

### 5.2 ãƒ­ã‚°è¨˜éŒ²ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

#### æ©Ÿå¯†æƒ…å ±ã®ãƒã‚¹ã‚­ãƒ³ã‚°
```typescript
const maskSensitiveData = (logData: any): any => {
  const masked = { ...logData };
  
  // APIã‚­ãƒ¼ã®ãƒã‚¹ã‚­ãƒ³ã‚°
  if (masked.apiKey) {
    masked.apiKey = masked.apiKey.substring(0, 4) + '****';
  }
  
  // IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®éƒ¨åˆ†ãƒã‚¹ã‚­ãƒ³ã‚°
  if (masked.ip) {
    const parts = masked.ip.split('.');
    if (parts.length === 4) {
      masked.ip = `${parts[0]}.${parts[1]}.xxx.xxx`;
    }
  }
  
  return masked;
};
```

## 6. æ³•çš„ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹

### 6.1 æŠ•è³‡åŠ©è¨€æ¥­å¯¾ç­–

#### å…è²¬äº‹é …ã®æ˜ç¢ºåŒ–
```typescript
const DISCLAIMER = {
  ja: "ã“ã®æƒ…å ±ã¯æŠ•è³‡ã®å‚è€ƒè³‡æ–™ã§ã‚ã‚Šã€æŠ•è³‡åŠ©è¨€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æœ€çµ‚çš„ãªæŠ•è³‡åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ã§ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚",
  en: "This information is for reference only and not investment advice. Please make your own investment decisions."
};

// å…¨ã¦ã®æŠ•è³‡åˆ¤å®šãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å…è²¬äº‹é …ã‚’ä»˜ä¸
const wrapInvestmentResponse = <T>(data: T): T & { disclaimer: string } => ({
  ...data,
  disclaimer: DISCLAIMER.ja
});
```

#### æŠ•è³‡æ¨å¥¨è¡¨ç¾ã®åˆ¶é™
```typescript
const SAFE_RECOMMENDATION_TERMS = {
  BUY: 'å‚è€ƒï¼šè²·ã„è¦ç´ ãŒå¤šã„',
  SELL: 'å‚è€ƒï¼šå£²ã‚Šè¦ç´ ãŒå¤šã„', 
  HOLD: 'å‚è€ƒï¼šæ§˜å­è¦‹ãŒæ¨å¥¨ã•ã‚Œã‚‹'
};

// æŠ•è³‡åŠ©è¨€ã¨èª¤è§£ã•ã‚Œãªã„è¡¨ç¾ã«çµ±ä¸€
const formatRecommendation = (rec: 'BUY' | 'SELL' | 'HOLD'): string => {
  return SAFE_RECOMMENDATION_TERMS[rec];
};
```

### 6.2 ãƒ‡ãƒ¼ã‚¿åˆ©ç”¨è¦ç´„ã®éµå®ˆ

#### å¤–éƒ¨APIåˆ©ç”¨è¦ç´„ãƒã‚§ãƒƒã‚¯
```typescript
const checkApiUsageCompliance = (usage: ApiUsageStats): boolean => {
  // Yahoo Finance APIåˆ©ç”¨åˆ¶é™ãƒã‚§ãƒƒã‚¯
  if (usage.yahooFinance.dailyRequests > 2000) {
    console.warn('Yahoo Finance API daily limit approaching');
    return false;
  }
  
  // Alpha Vantage APIåˆ©ç”¨åˆ¶é™ãƒã‚§ãƒƒã‚¯
  if (usage.alphaVantage.minuteRequests > 5) {
    console.warn('Alpha Vantage API minute limit exceeded');
    return false;
  }
  
  return true;
};
```

## 7. å°†æ¥ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½

### 7.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ï¼ˆPhase 2äºˆå®šï¼‰

#### JWTèªè¨¼ã®æº–å‚™
```typescript
import jwt from 'jsonwebtoken';
import bcrypt from 'bcrypt';

interface AuthConfig {
  jwtSecret: string;
  jwtExpiry: string;
  saltRounds: number;
}

class AuthService {
  private config: AuthConfig;

  async hashPassword(password: string): Promise<string> {
    return bcrypt.hash(password, this.config.saltRounds);
  }

  async verifyPassword(password: string, hash: string): Promise<boolean> {
    return bcrypt.compare(password, hash);
  }

  generateToken(userId: string): string {
    return jwt.sign(
      { userId },
      this.config.jwtSecret,
      { expiresIn: this.config.jwtExpiry }
    );
  }

  verifyToken(token: string): { userId: string } | null {
    try {
      return jwt.verify(token, this.config.jwtSecret) as { userId: string };
    } catch {
      return null;
    }
  }
}
```

### 7.2 ç›£æŸ»ãƒ­ã‚°ï¼ˆPhase 3äºˆå®šï¼‰

#### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã®è¨˜éŒ²
```typescript
interface SecurityEvent {
  id: string;
  userId?: string;
  eventType: 'LOGIN' | 'API_ACCESS' | 'DATA_EXPORT' | 'SETTINGS_CHANGE';
  ipAddress: string;
  userAgent: string;
  success: boolean;
  timestamp: Date;
  metadata?: Record<string, any>;
}

class SecurityLogger {
  async logEvent(event: Omit<SecurityEvent, 'id' | 'timestamp'>): Promise<void> {
    const securityEvent: SecurityEvent = {
      ...event,
      id: generateUUID(),
      timestamp: new Date()
    };

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¾ãŸã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²
    await this.writeToSecurityLog(securityEvent);
  }

  private async writeToSecurityLog(event: SecurityEvent): Promise<void> {
    // å®Ÿè£…: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã®æ°¸ç¶šåŒ–
  }
}
```

## 8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–

### 8.1 ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è„…å¨æ¤œçŸ¥

#### ç•°å¸¸ãªã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œçŸ¥
```typescript
class ThreatDetector {
  private suspiciousPatterns = {
    rapidRequests: { threshold: 10, window: 60000 }, // 1åˆ†é–“ã«10å›ä»¥ä¸Š
    invalidSymbols: { threshold: 5, window: 300000 }, // 5åˆ†é–“ã«5å›ä»¥ä¸Šã®ç„¡åŠ¹ãªéŠ˜æŸ„ã‚³ãƒ¼ãƒ‰
  };

  async detectThreats(request: SecurityContext): Promise<ThreatLevel> {
    const threats = await Promise.all([
      this.checkRapidRequests(request),
      this.checkInvalidSymbols(request),
      this.checkGeoLocation(request)
    ]);

    return this.calculateThreatLevel(threats);
  }

  private async checkRapidRequests(context: SecurityContext): Promise<boolean> {
    // å®Ÿè£…: çŸ­æ™‚é–“ã§ã®å¤§é‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯
    return false;
  }
}
```

### 8.2 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒˆãƒªã‚¯ã‚¹

#### KPIã®ç›£è¦–
```typescript
interface SecurityMetrics {
  failedAuthAttempts: number;
  blockedRequests: number;
  apiKeyViolations: number;
  dataIntegrityIssues: number;
  responseTimeAnomalies: number;
}

const collectSecurityMetrics = (): SecurityMetrics => {
  return {
    failedAuthAttempts: getFailedAuthCount(),
    blockedRequests: getBlockedRequestCount(),
    apiKeyViolations: getApiKeyViolationCount(),
    dataIntegrityIssues: getDataIntegrityIssueCount(),
    responseTimeAnomalies: getResponseTimeAnomalyCount()
  };
};
```

## 10. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆçµæœ

### 10.1 å®Ÿè£…æ¸ˆã¿å¯¾ç­–ã®å‹•ä½œç¢ºèª

#### XSSæ”»æ’ƒãƒ†ã‚¹ãƒˆ
```bash
# ãƒ†ã‚¹ãƒˆ: æ‚ªæ„ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æŒ¿å…¥
curl "http://localhost:5001/api/companies/search?query=<script>alert('xss')</script>"
# çµæœ: âœ… ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿ {"success":false,"error":"Invalid query parameter"}
```

#### ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ†ã‚¹ãƒˆ
```bash
# ãƒ†ã‚¹ãƒˆ: 25å›é€£ç¶šã‚¢ã‚¯ã‚»ã‚¹
for i in {1..25}; do curl -s "http://localhost:5001/api/health" > /dev/null; done
# çµæœ: âœ… åˆ¶é™ä½œå‹• {"error":"API rate limit exceeded"}
```

#### é•·ã•åˆ¶é™ãƒ†ã‚¹ãƒˆ
```bash
# ãƒ†ã‚¹ãƒˆ: 300æ–‡å­—è¶…ã®ã‚¯ã‚¨ãƒª
curl "http://localhost:5001/api/companies/search?query=VERY_LONG_STRING..."
# çµæœ: âœ… ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿ {"success":false,"error":"Invalid query parameter"}
```

#### ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ãƒ†ã‚¹ãƒˆ
```bash
# ãƒ†ã‚¹ãƒˆ: ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€æ­£å¸¸ãªã‚¯ã‚¨ãƒª
curl "http://localhost:5001/api/companies/search?query=Apple"
# çµæœ: âœ… ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ¸ˆã¿ "REITâ€”Hotel &amp; Motel"
```

### 10.2 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«è©•ä¾¡

#### ğŸŸ¢ é«˜ãƒ¬ãƒ™ãƒ«é”æˆæ¸ˆã¿
- **å¤šå±¤é˜²å¾¡**: å…¥åŠ›â†’å‡¦ç†â†’å‡ºåŠ›ã®å„æ®µéšã§ä¿è­·
- **é‡‘èã‚¢ãƒ—ãƒªå¯¾å¿œ**: æŠ•è³‡åŠ©è¨€æ¥­æ³•ã¸ã®é…æ…®
- **å®Ÿæˆ¦çš„å¯¾ç­–**: å®Ÿéš›ã®æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒ–ãƒ­ãƒƒã‚¯
- **å°†æ¥æ‹¡å¼µæº–å‚™**: Phase 2ãƒ»3ã¸ã®è¨­è¨ˆå®Œäº†

#### ğŸŸ¡ ç¶™ç¶šç›£è¦–é …ç›®
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ï¼ˆ9ä»¶æ¤œå‡ºï¼‰
- å¤–éƒ¨APIåˆ©ç”¨åˆ¶é™ã®éµå®ˆçŠ¶æ³
- CSPé•åãƒ¬ãƒãƒ¼ãƒˆã®åé›†ãƒ»åˆ†æ

### 10.3 æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®è¿½åŠ å¯¾ç­–

```bash
# 1. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
export NODE_ENV=production
export ALLOWED_ORIGINS="https://your-domain.com,https://www.your-domain.com"

# 2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è„†å¼±æ€§ã®ä¿®æ­£
npm audit fix --force

# 3. HTTPSå¼·åˆ¶è¨­å®š
# nginx ã¾ãŸã¯ CloudFront ã§ã® HTTPS ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨­å®š

# 4. ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰
# ãƒ­ã‚°åˆ†æã€ç•°å¸¸æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã®å°å…¥
```

### 10.4 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] XSSæ”»æ’ƒå¯¾ç­–ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰
- [x] CSRFæ”»æ’ƒå¯¾ç­–ï¼ˆSameSite Cookieè¨­å®šï¼‰
- [x] SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼ˆParameterized Queryæº–å‚™ï¼‰
- [x] DoS/DDoSæ”»æ’ƒå¯¾ç­–ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ï¼‰
- [x] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆCSPã€HSTSã€X-Frame-Optionsï¼‰
- [x] å…¥åŠ›æ¤œè¨¼ãƒ»ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
- [x] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆæƒ…å ±æ¼æ´©é˜²æ­¢ï¼‰
- [x] æ³•çš„ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ï¼ˆæŠ•è³‡åŠ©è¨€æ¥­æ³•å¯¾å¿œï¼‰
- [ ] ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ä¿®æ­£ï¼ˆè¦å¯¾å¿œï¼‰
- [x] APIåˆ©ç”¨åˆ¶é™éµå®ˆ

ã“ã®åŒ…æ‹¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆã«ã‚ˆã‚Šã€**é‡‘èã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦æœ€é«˜æ°´æº–ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«**ã‚’ç¢ºä¿ã—ã¦ã„ã¾ã™ã€‚