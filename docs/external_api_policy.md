# 外部API統合ポリシー・コスト管理ドキュメント

## 概要
本ドキュメントは、株式分析システムで使用する外部APIの方針、コスト管理、認証情報管理について定めるものです。

## API プロバイダー一覧と料金体系

### 1. Yahoo Finance API
**種別**: 無料API（非公式）
**用途**: 株価検索、リアルタイム株価データ取得
**制限**: 
- 100リクエスト/分（推定）
- 2000リクエスト/日（推定）
**コスト**: 無料
**認証**: 不要
**リスク**: 
- ⚠️ 非公式APIのため予告なく停止する可能性
- 利用規約変更のリスク
**対策**: 他のAPIプロバイダーでのフェールオーバー実装済み

### 2. Alpha Vantage API
**種別**: Freemium API
**用途**: 株価データ、企業検索
**制限**: 
- 無料プラン: 25リクエスト/日、5リクエスト/分
- 有料プラン: $49.99/月で500リクエスト/分
**コスト**: 
- 開発・テスト: 無料
- 本格運用時: $49.99/月（必要に応じて）
**認証**: APIキー必要
**取得方法**: https://www.alphavantage.co/
**環境変数**: `ALPHA_VANTAGE_API_KEY`

### 3. Polygon.io API
**種別**: Freemium API
**用途**: 株価データ、企業情報
**制限**: 
- 無料プラン: 5リクエスト/分
- Basic ($9.95/月): 100リクエスト/分
- Starter ($79/月): 1000リクエスト/分
**コスト**: 
- 開発・テスト: 無料
- 小規模運用: $9.95/月
- 中規模運用: $79/月
**認証**: APIキー必要
**取得方法**: https://polygon.io/
**環境変数**: `POLYGON_API_KEY`

### 4. IEX Cloud API
**種別**: Freemium API
**用途**: 株価データ
**制限**: 
- 無料プラン: 50万メッセージ/月
- Start ($9/月): 500万メッセージ/月
- Grow ($99/月): 5000万メッセージ/月
**コスト**: 
- 開発・テスト: 無料（Sandbox環境）
- 小規模運用: $9/月
- 中規模運用: $99/月
**認証**: APIキー必要
**取得方法**: https://iexcloud.io/
**環境変数**: `IEX_CLOUD_API_KEY`

## 認証情報管理方針

### 環境変数による管理
```bash
# 必須API キー
ALPHA_VANTAGE_API_KEY=your_alpha_vantage_key
POLYGON_API_KEY=your_polygon_key
IEX_CLOUD_API_KEY=your_iex_key

# オプション（無料APIのため）
YAHOO_FINANCE_API_KEY=  # 不要
```

### セキュリティ要件
1. **本番環境**:
   - 実際のAPIキーを使用
   - 環境変数またはシークレット管理サービスで管理
   - 定期的なローテーション（推奨：3ヶ月）

2. **開発環境**:
   - デモキー使用可能（機能制限あり）
   - 開発者個人のAPIキー使用
   - `.env`ファイルでローカル管理（.gitignoreに追加済み）

3. **テスト環境**:
   - サンドボックス環境のAPIキー使用
   - モックレスポンス優先
   - API呼び出し数を最小限に抑制

### APIキー取得手順
1. **Alpha Vantage**:
   - https://www.alphavantage.co/ でアカウント作成
   - 無料プランでAPIキー即時発行
   - デモキー `demo` も利用可能（制限あり）

2. **Polygon.io**:
   - https://polygon.io/ でアカウント作成
   - 無料プランでAPIキー発行
   - クレジットカード登録不要

3. **IEX Cloud**:
   - https://iexcloud.io/ でアカウント作成
   - Sandbox環境で無料テスト可能
   - 本番用APIキーは支払い情報登録後

## コスト最適化戦略

### 1. 階層的フェールオーバー戦略
```
優先度1: Yahoo Finance (無料) → 検索・基本株価データ
優先度2: Alpha Vantage (無料枠) → 詳細財務データ
優先度3: Polygon.io (無料枠) → 追加データソース
優先度4: IEX Cloud (無料枠) → 最終フォールバック
優先度5: データベースキャッシュ → API障害時
優先度6: モックデータ → 完全フォールバック
```

### 2. レート制限管理
- **アグレッシブキャッシュ**: 5分間キャッシュ
- **サーキットブレーカー**: 連続5回失敗で30秒ブロック
- **リクエスト分散**: 複数プロバイダー間でロードバランシング

### 3. コスト監視
- **日次制限**: 各API の無料枠以内での運用
- **月次レビュー**: API使用量とコストの定期確認
- **アラート設定**: 制限の80%達成時に通知

## 運用レベル別推奨構成

### 開発・プロトタイプ段階
- **コスト**: $0/月
- **構成**: 全て無料プラン + Yahoo Finance
- **制限**: 機能制限あり、テスト用途のみ

### 小規模運用（〜1000ユーザー）
- **推定コスト**: $10-20/月
- **構成**: 
  - Polygon.io Basic ($9.95/月)
  - Alpha Vantage 無料プラン
  - Yahoo Finance + キャッシュ強化
- **想定負荷**: 10,000リクエスト/日

### 中規模運用（1000-10000ユーザー）
- **推定コスト**: $80-150/月
- **構成**:
  - Polygon.io Starter ($79/月)
  - Alpha Vantage 有料プラン ($49.99/月)
  - IEX Cloud Start ($9/月)
- **想定負荷**: 100,000リクエスト/日

### 大規模運用（10000+ユーザー）
- **推定コスト**: $200-500/月
- **構成**:
  - 複数プロバイダーのプレミアムプラン
  - 専用CDN + キャッシュレイヤー
  - 独自データソース検討

## 障害対応計画

### API障害時の対応フロー
1. **自動フェールオーバー**: 別プロバイダーに自動切替
2. **キャッシュ利用**: 直近データをキャッシュから提供
3. **モックデータ**: システム継続のため一時的に模擬データ提供
4. **ユーザー通知**: 機能制限についてUI上で通知

### 制限超過時の対応
1. **レート制限**: 一時的なアクセス制御
2. **プロバイダー切替**: 別APIに自動ローテーション
3. **キャッシュ延長**: TTLを延長してAPI負荷軽減
4. **プラン升格**: 緊急時の有料プラン切替手順

## コンプライアンス・利用規約

### 各プロバイダーの利用規約遵守
1. **Yahoo Finance**: 
   - ⚠️ 非公式のため商用利用時は要確認
   - アクセス頻度の自主制限

2. **Alpha Vantage**: 
   - 利用規約準拠
   - データの再配布禁止

3. **Polygon.io**: 
   - 適切なクレジット表示
   - リアルタイムデータの制限事項確認

4. **IEX Cloud**: 
   - データ利用ポリシー準拠
   - 適切なデータ属性表示

### データ保護とプライバシー
- **個人情報**: APIキーやユーザーデータの適切な保護
- **データ保存**: 必要最小限のデータのみキャッシュ
- **ログ管理**: APIアクセスログの適切な管理と削除

## 実装状況と次のステップ

### ✅ 実装済み
- Multi-Source API Manager
- フェールオーバー機能
- レート制限管理
- 基本的なキャッシュ機能

### 🔄 実装中
- エラーハンドリングの改善
- API統計の詳細化
- パフォーマンス最適化

### 📋 今後の実装予定
- コスト監視ダッシュボード
- API使用量アラート
- 動的プラン切替機能
- 詳細なアクセス解析

## 緊急連絡先・エスカレーション

### API障害報告先
- Alpha Vantage: support@alphavantage.co
- Polygon.io: support@polygon.io
- IEX Cloud: support@iexcloud.io

### 内部エスカレーション
1. **Level 1**: 自動復旧・フェールオーバー
2. **Level 2**: システム管理者への自動通知
3. **Level 3**: 開発チームへの緊急連絡
4. **Level 4**: ビジネス責任者への報告

---

**最終更新**: 2025年6月21日
**次回レビュー予定**: 2025年7月21日
**責任者**: 開発チーム